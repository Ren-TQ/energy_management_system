# Entityå±‚é¢†åŸŸæ¨¡å‹åˆ†æ

## ğŸ“Š æ¨¡å‹ç±»å‹åˆ¤æ–­

### ç»“è®ºï¼šæœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯ **è´«è¡€æ¨¡å‹ï¼ˆAnemic Domain Modelï¼‰**

---

## ğŸ” ä¸€ã€è´«è¡€æ¨¡å‹ vs å……è¡€æ¨¡å‹

### 1. è´«è¡€æ¨¡å‹ï¼ˆAnemic Domain Modelï¼‰

**å®šä¹‰**ï¼š
- å®ä½“ç±»åªåŒ…å«æ•°æ®å­—æ®µå’Œgetter/setteræ–¹æ³•
- **æ²¡æœ‰ä¸šåŠ¡é€»è¾‘æ–¹æ³•**
- ä¸šåŠ¡é€»è¾‘éƒ½åœ¨Serviceå±‚ï¼ˆä¸šåŠ¡æœåŠ¡å±‚ï¼‰

**ç‰¹ç‚¹**ï¼š
- âœ… å®ä½“ç±»ç»“æ„ç®€å•ï¼Œåªè´Ÿè´£æ•°æ®å­˜å‚¨
- âœ… ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨Serviceå±‚ï¼Œæ˜“äºç®¡ç†
- âœ… ç¬¦åˆSpring/JPAçš„å¸¸è§å®è·µ
- âš ï¸ å®ä½“ç±»ç¼ºå°‘è¡Œä¸ºï¼Œæ›´åƒæ•°æ®ç»“æ„

### 2. å……è¡€æ¨¡å‹ï¼ˆRich Domain Modelï¼‰

**å®šä¹‰**ï¼š
- å®ä½“ç±»åŒ…å«æ•°æ®å­—æ®µå’Œä¸šåŠ¡é€»è¾‘æ–¹æ³•
- ä¸šåŠ¡é€»è¾‘å°è£…åœ¨å®ä½“ç±»å†…éƒ¨
- Serviceå±‚åªè´Ÿè´£åè°ƒå’Œäº‹åŠ¡ç®¡ç†

**ç‰¹ç‚¹**ï¼š
- âœ… å®ä½“ç±»å…·æœ‰è¡Œä¸ºï¼Œæ›´ç¬¦åˆé¢å‘å¯¹è±¡è®¾è®¡
- âœ… ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®ç´§å¯†è€¦åˆ
- âš ï¸ å®ä½“ç±»å¯èƒ½å˜å¾—å¤æ‚
- âš ï¸ åœ¨JPAä¸­å¯èƒ½å¸¦æ¥åºåˆ—åŒ–é—®é¢˜

---

## ğŸ“ äºŒã€æœ¬é¡¹ç›®Entityå±‚åˆ†æ

### æ£€æŸ¥ç»“æœ

æ£€æŸ¥äº†æ‰€æœ‰Entityç±»ï¼š
- `Device.java`
- `Building.java`
- `EnergyData.java`
- `Alert.java`
- `User.java`

### å…±åŒç‰¹å¾

æ‰€æœ‰Entityç±»éƒ½åªåŒ…å«ï¼š

1. **æ•°æ®å­—æ®µ**ï¼ˆç§æœ‰å±æ€§ï¼‰
   ```java
   private Long id;
   private String name;
   private DeviceStatus status;
   // ...
   ```

2. **JPAæ³¨è§£**ï¼ˆæ•°æ®æ˜ å°„ï¼‰
   ```java
   @Entity
   @Table(name = "t_device")
   @Column(name = "name")
   @ManyToOne
   // ...
   ```

3. **Lombokæ³¨è§£**ï¼ˆè‡ªåŠ¨ç”Ÿæˆgetter/setterï¼‰
   ```java
   @Data
   @Builder
   @NoArgsConstructor
   @AllArgsConstructor
   ```

4. **ç”Ÿå‘½å‘¨æœŸå›è°ƒ**ï¼ˆæ•°æ®æŒä¹…åŒ–é’©å­ï¼‰
   ```java
   @PrePersist
   protected void onCreate() {
       this.createdAt = LocalDateTime.now();
   }
   ```

5. **å…³è”å…³ç³»**ï¼ˆJPAå…³ç³»æ˜ å°„ï¼‰
   ```java
   @OneToMany(mappedBy = "device")
   private List<EnergyData> energyDataList;
   ```

### âŒ ç¼ºå°‘çš„å†…å®¹

æ‰€æœ‰Entityç±»éƒ½**æ²¡æœ‰**ï¼š
- âŒ ä¸šåŠ¡é€»è¾‘æ–¹æ³•
- âŒ ä¸šåŠ¡è§„åˆ™éªŒè¯æ–¹æ³•
- âŒ é¢†åŸŸè¡Œä¸ºæ–¹æ³•

ä¾‹å¦‚ï¼Œ`Device`å®ä½“ç±»ä¸­**æ²¡æœ‰**è¿™æ ·çš„æ–¹æ³•ï¼š
```java
// è¿™äº›æ–¹æ³•åœ¨è´«è¡€æ¨¡å‹ä¸­ä¸å­˜åœ¨
public boolean isOverloaded() { ... }
public void updateStatus(DeviceStatus newStatus) { ... }
public boolean canBeDeleted() { ... }
```

---

## ğŸ”„ ä¸‰ã€ä¸šåŠ¡é€»è¾‘çš„ä½ç½®

### ä¸šåŠ¡é€»è¾‘éƒ½åœ¨Serviceå±‚

#### ç¤ºä¾‹1ï¼šè®¾å¤‡ä¸šåŠ¡é€»è¾‘

**Entityå±‚ï¼ˆDevice.javaï¼‰**ï¼š
```java
@Entity
public class Device {
    private Long id;
    private String name;
    private DeviceStatus status;
    private Double ratedPower;
    // åªæœ‰æ•°æ®å­—æ®µï¼Œæ²¡æœ‰ä¸šåŠ¡æ–¹æ³•
}
```

**Serviceå±‚ï¼ˆDeviceService.javaï¼‰**ï¼š
```java
@Service
public class DeviceService {
    // ä¸šåŠ¡é€»è¾‘éƒ½åœ¨è¿™é‡Œ
    public DeviceDTO createDevice(CreateDeviceRequest request) {
        // ä¸šåŠ¡éªŒè¯
        if (deviceRepository.existsBySerialNumber(request.getSerialNumber())) {
            throw new BusinessException("è®¾å¤‡åºåˆ—å·å·²å­˜åœ¨");
        }
        // ä¸šåŠ¡è§„åˆ™
        if (deviceRepository.existsByBuildingIdAndRoomNumber(...)) {
            throw new BusinessException("åŒä¸€æˆ¿é—´ä¸èƒ½æœ‰å¤šä¸ªè®¾å¤‡");
        }
        // åˆ›å»ºé€»è¾‘
        Device device = Device.builder()...build();
        return convertToDTO(deviceRepository.save(device));
    }
    
    public void updateDeviceStatus(Long id, DeviceStatus status) {
        // ä¸šåŠ¡é€»è¾‘
        Device device = findById(id);
        // çŠ¶æ€è½¬æ¢è§„åˆ™
        if (device.getStatus() == DeviceStatus.OFFLINE && status == DeviceStatus.ONLINE) {
            // ä¸šåŠ¡é€»è¾‘å¤„ç†
        }
        device.setStatus(status);
        deviceRepository.save(device);
    }
}
```

#### ç¤ºä¾‹2ï¼šå‘Šè­¦ä¸šåŠ¡é€»è¾‘

**Entityå±‚ï¼ˆAlert.javaï¼‰**ï¼š
```java
@Entity
public class Alert {
    private Long id;
    private AlertType alertType;
    private Boolean isResolved;
    // åªæœ‰æ•°æ®å­—æ®µ
}
```

**Serviceå±‚ï¼ˆAlertService.javaï¼‰**ï¼š
```java
@Service
public class AlertService {
    // å‘Šè­¦æ£€æŸ¥çš„ä¸šåŠ¡é€»è¾‘
    public void checkAndTriggerAlerts(Device device, EnergyData energyData) {
        for (AlertStrategy strategy : alertStrategies) {
            Optional<Alert> alertOpt = strategy.checkAlert(device, energyData);
            if (alertOpt.isPresent()) {
                Alert alert = alertOpt.get();
                alertSubject.notifyObservers(alert);
            }
        }
    }
    
    // å¤„ç†å‘Šè­¦çš„ä¸šåŠ¡é€»è¾‘
    public void resolveAlert(Long id, String note) {
        Alert alert = findById(id);
        alert.setIsResolved(true);
        alert.setResolvedAt(LocalDateTime.now());
        alert.setResolveNote(note);
        alertRepository.save(alert);
    }
}
```

---

## ğŸ“Š å››ã€æ¶æ„å¯¹æ¯”

### è´«è¡€æ¨¡å‹æ¶æ„ï¼ˆæœ¬é¡¹ç›®ï¼‰

```
Controllerå±‚
    â†“
Serviceå±‚ï¼ˆæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ï¼‰
    â†“
Repositoryå±‚
    â†“
Entityå±‚ï¼ˆåªæœ‰æ•°æ®ï¼Œæ— ä¸šåŠ¡é€»è¾‘ï¼‰
    â†“
æ•°æ®åº“
```

**ç‰¹ç‚¹**ï¼š
- Entityæ˜¯"å“‘"å¯¹è±¡ï¼ˆDumb Objectï¼‰
- ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨Serviceå±‚
- ç¬¦åˆäº‹åŠ¡è„šæœ¬æ¨¡å¼

### å……è¡€æ¨¡å‹æ¶æ„ï¼ˆå¯¹æ¯”ï¼‰

```
Controllerå±‚
    â†“
Serviceå±‚ï¼ˆåè°ƒå’Œäº‹åŠ¡ï¼‰
    â†“
Entityå±‚ï¼ˆåŒ…å«ä¸šåŠ¡é€»è¾‘ï¼‰
    â†“
Repositoryå±‚
    â†“
æ•°æ®åº“
```

**ç‰¹ç‚¹**ï¼š
- Entityæ˜¯"æ™ºèƒ½"å¯¹è±¡ï¼ˆSmart Objectï¼‰
- ä¸šåŠ¡é€»è¾‘å°è£…åœ¨Entityå†…éƒ¨
- ç¬¦åˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰

---

## âœ… äº”ã€ä¸ºä»€ä¹ˆä½¿ç”¨è´«è¡€æ¨¡å‹

### 1. Spring/JPAçš„å¸¸è§å®è·µ

- Springæ¡†æ¶æ¨èå°†ä¸šåŠ¡é€»è¾‘æ”¾åœ¨Serviceå±‚
- JPAå®ä½“ç±»ä¸»è¦ç”¨äºæ•°æ®æ˜ å°„
- ç¬¦åˆSpring MVCçš„æ ‡å‡†æ¶æ„

### 2. æ˜“äºç®¡ç†

- ä¸šåŠ¡é€»è¾‘é›†ä¸­ï¼Œæ˜“äºæŸ¥æ‰¾å’Œç»´æŠ¤
- Serviceå±‚å¯ä»¥æ–¹ä¾¿åœ°æ·»åŠ äº‹åŠ¡ç®¡ç†
- ä¾¿äºå•å…ƒæµ‹è¯•ï¼ˆå¯ä»¥Mock Repositoryï¼‰

### 3. çµæ´»æ€§

- Entityç±»ç»“æ„ç®€å•ï¼Œæ˜“äºåºåˆ—åŒ–
- å¯ä»¥è½»æ¾è½¬æ¢ä¸ºDTO
- ä¸ä¾èµ–ä¸šåŠ¡é€»è¾‘ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨

### 4. å›¢é˜Ÿåä½œ

- æ•°æ®æ¨¡å‹å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»
- å‰ç«¯å¼€å‘äººå‘˜åªéœ€å…³æ³¨Entityç»“æ„
- åç«¯å¼€å‘äººå‘˜ä¸“æ³¨äºServiceå±‚ä¸šåŠ¡é€»è¾‘

---

## ğŸ”„ å…­ã€å¦‚ä½•æ”¹é€ ä¸ºå……è¡€æ¨¡å‹ï¼ˆç¤ºä¾‹ï¼‰

å¦‚æœè¦æ”¹é€ ä¸ºå……è¡€æ¨¡å‹ï¼Œå¯ä»¥åœ¨Entityä¸­æ·»åŠ ä¸šåŠ¡æ–¹æ³•ï¼š

### æ”¹é€ ç¤ºä¾‹ï¼šDeviceå®ä½“

```java
@Entity
public class Device {
    // æ•°æ®å­—æ®µ
    private Long id;
    private String name;
    private DeviceStatus status;
    private Double ratedPower;
    
    // ä¸šåŠ¡é€»è¾‘æ–¹æ³•ï¼ˆå……è¡€æ¨¡å‹ï¼‰
    public boolean isOverloaded(Double currentPower) {
        return currentPower > this.ratedPower * 1.2;
    }
    
    public void updateStatus(DeviceStatus newStatus) {
        if (this.status == DeviceStatus.OFFLINE && newStatus == DeviceStatus.ONLINE) {
            // ä¸šåŠ¡è§„åˆ™ï¼šä»ç¦»çº¿åˆ°åœ¨çº¿éœ€è¦éªŒè¯
            this.status = newStatus;
        } else {
            this.status = newStatus;
        }
    }
    
    public boolean canBeDeleted() {
        // ä¸šåŠ¡è§„åˆ™ï¼šæœ‰èƒ½è€—æ•°æ®çš„è®¾å¤‡ä¸èƒ½åˆ é™¤
        return this.energyDataList == null || this.energyDataList.isEmpty();
    }
    
    public void validateSerialNumber(String serialNumber) {
        if (serialNumber == null || serialNumber.trim().isEmpty()) {
            throw new IllegalArgumentException("è®¾å¤‡åºåˆ—å·ä¸èƒ½ä¸ºç©º");
        }
        if (!serialNumber.matches("^METER_[A-Z0-9_]+$")) {
            throw new IllegalArgumentException("è®¾å¤‡åºåˆ—å·æ ¼å¼ä¸æ­£ç¡®");
        }
    }
}
```

### æ”¹é€ åçš„Serviceå±‚

```java
@Service
public class DeviceService {
    public DeviceDTO createDevice(CreateDeviceRequest request) {
        Device device = Device.builder()...build();
        
        // ä½¿ç”¨Entityçš„ä¸šåŠ¡æ–¹æ³•
        device.validateSerialNumber(request.getSerialNumber());
        
        return convertToDTO(deviceRepository.save(device));
    }
    
    public void checkDeviceOverload(Device device, EnergyData energyData) {
        // ä½¿ç”¨Entityçš„ä¸šåŠ¡æ–¹æ³•
        if (device.isOverloaded(energyData.getPower())) {
            // è§¦å‘å‘Šè­¦
        }
    }
}
```

---

## ğŸ“‹ ä¸ƒã€æ€»ç»“

### æœ¬é¡¹ç›®ä½¿ç”¨çš„æ¨¡å‹

| ç‰¹æ€§ | æœ¬é¡¹ç›®ï¼ˆè´«è¡€æ¨¡å‹ï¼‰ |
|------|------------------|
| **EntityåŒ…å«** | æ•°æ®å­—æ®µã€getter/setterã€JPAæ³¨è§£ |
| **Entityä¸åŒ…å«** | ä¸šåŠ¡é€»è¾‘æ–¹æ³• |
| **ä¸šåŠ¡é€»è¾‘ä½ç½®** | Serviceå±‚ |
| **ä¼˜ç‚¹** | ç»“æ„ç®€å•ã€æ˜“äºç®¡ç†ã€ç¬¦åˆSpringå®è·µ |
| **ç¼ºç‚¹** | Entityç¼ºå°‘è¡Œä¸ºï¼Œæ›´åƒæ•°æ®ç»“æ„ |

### é€‚ç”¨åœºæ™¯

**è´«è¡€æ¨¡å‹é€‚åˆ**ï¼š
- âœ… Spring/JPAé¡¹ç›®
- âœ… ä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•
- âœ… éœ€è¦é¢‘ç¹è½¬æ¢Entityå’ŒDTO
- âœ… å›¢é˜Ÿåä½œï¼ŒèŒè´£åˆ†ç¦»

**å……è¡€æ¨¡å‹é€‚åˆ**ï¼š
- âœ… å¤æ‚ä¸šåŠ¡é¢†åŸŸ
- âœ… é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰
- âœ… ä¸šåŠ¡è§„åˆ™ä¸æ•°æ®ç´§å¯†ç›¸å…³
- âœ… éœ€è¦å°è£…é¢†åŸŸè¡Œä¸º

---

## ğŸ’¡ å…«ã€å»ºè®®

### å½“å‰é¡¹ç›®

ä¿æŒè´«è¡€æ¨¡å‹æ˜¯**åˆç†çš„é€‰æ‹©**ï¼Œå› ä¸ºï¼š
1. ç¬¦åˆSpringæ¡†æ¶çš„æœ€ä½³å®è·µ
2. ä¸šåŠ¡é€»è¾‘ç›¸å¯¹ç®€å•ï¼Œé›†ä¸­åœ¨Serviceå±‚æ˜“äºç®¡ç†
3. å›¢é˜Ÿåä½œæ—¶èŒè´£æ¸…æ™°
4. æ˜“äºæµ‹è¯•å’Œç»´æŠ¤

### å¦‚æœä¸šåŠ¡å˜å¤æ‚

å¦‚æœæœªæ¥ä¸šåŠ¡é€»è¾‘å˜å¾—éå¸¸å¤æ‚ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. å¼•å…¥é¢†åŸŸæœåŠ¡ï¼ˆDomain Serviceï¼‰
2. éƒ¨åˆ†ä½¿ç”¨å……è¡€æ¨¡å‹ï¼ˆæ··åˆæ¨¡å¼ï¼‰
3. é‡‡ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰

---

## ğŸ“š ç›¸å…³æ¦‚å¿µ

- **è´«è¡€æ¨¡å‹ï¼ˆAnemic Domain Modelï¼‰**: Martin Fowleræå‡ºçš„åæ¨¡å¼ï¼Œä½†åœ¨Springé¡¹ç›®ä¸­æ˜¯å¸¸è§å®è·µ
- **å……è¡€æ¨¡å‹ï¼ˆRich Domain Modelï¼‰**: é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰ä¸­çš„æ¨èæ¨¡å¼
- **é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰**: å¼ºè°ƒé¢†åŸŸæ¨¡å‹åº”è¯¥åŒ…å«ä¸šåŠ¡é€»è¾‘
- **äº‹åŠ¡è„šæœ¬æ¨¡å¼**: ä¸šåŠ¡é€»è¾‘åœ¨Serviceå±‚ï¼ŒEntityåªæ˜¯æ•°æ®å®¹å™¨

